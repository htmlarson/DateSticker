<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Change Count</title>
  <style>
    :root { --bg:#111827; --ink:#e5e7eb; --line:#374151; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--ink);padding:20px}
    h1{margin:0 0 12px;text-align:center}
    .wrap{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}

    fieldset{border:1px solid var(--line);border-radius:12px;min-width:0}
    legend{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-weight:600}

    .col{padding:12px}
    /* label | loose | rolls */
    .row{display:grid;grid-template-columns:1fr 110px 110px;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed var(--line)}
    .row:last-child{border-bottom:0}
    label{color:#cbd5e1}
    input[type=number]{width:110px;justify-self:end;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#0f172a;color:var(--ink);text-align:right}
    .hintcell{color:#9ca3af;font-size:.8rem;text-align:center}

    .totals{margin-top:16px;display:grid;gap:12px}
    .totals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .totals-grid--main{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .totals-grid--wide{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .box{border:1px solid var(--line);border-radius:10px;padding:10px;text-align:center;background:#0f172a}
    .label{display:block;color:#9ca3af;font-size:0.85rem;margin-bottom:4px}
    .value{font-variant-numeric:tabular-nums;font-weight:700}

    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:-6px -6px 8px 0}
    button{background:#0f172a;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.15)}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0f172a;border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:#e5e7eb;z-index:100}
  </style>
</head>
<body>
  <h1>Change Count</h1>
  <p style="text-align:center;color:#9ca3af;margin-top:4px;margin-bottom:18px;">Saved with key: <strong id="date-key"></strong></p>
  <div class="wrap">
    <!-- Drawer 3 (left) -->
    <fieldset class="col" aria-labelledby="d3-legend">
      <legend id="d3-legend">Drawer 3</legend>
      <div class="controls"><button type="button" data-balance="3">Balance</button></div>
      <div class="row">
        <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
      </div>
      <div class="row"><label for="d3-q">Quarters</label><input id="d3-q" name="d3-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-q-r" name="d3-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d3-d">Dimes</label><input id="d3-d" name="d3-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-d-r" name="d3-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d3-n">Nickels</label><input id="d3-n" name="d3-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-n-r" name="d3-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d3-p">Pennies</label><input id="d3-p" name="d3-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-p-r" name="d3-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
    </fieldset>

    <!-- Drawer 2 (middle) -->
    <fieldset class="col" aria-labelledby="d2-legend">
      <legend id="d2-legend">Drawer 2</legend>
      <div class="controls"><button type="button" data-balance="2">Balance</button></div>
      <div class="row">
        <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
      </div>
      <div class="row"><label for="d2-q">Quarters</label><input id="d2-q" name="d2-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-q-r" name="d2-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d2-d">Dimes</label><input id="d2-d" name="d2-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-d-r" name="d2-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d2-n">Nickels</label><input id="d2-n" name="d2-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-n-r" name="d2-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d2-p">Pennies</label><input id="d2-p" name="d2-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-p-r" name="d2-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
    </fieldset>

    <!-- Drawer 1 (right) -->
    <fieldset class="col" aria-labelledby="d1-legend">
      <legend id="d1-legend">Drawer 1</legend>
      <div class="controls"><button type="button" data-balance="1">Balance</button></div>
      <div class="row">
        <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
      </div>
      <div class="row"><label for="d1-q">Quarters</label><input id="d1-q" name="d1-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-q-r" name="d1-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d1-d">Dimes</label><input id="d1-d" name="d1-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-d-r" name="d1-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d1-n">Nickels</label><input id="d1-n" name="d1-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-n-r" name="d1-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
      <div class="row"><label for="d1-p">Pennies</label><input id="d1-p" name="d1-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-p-r" name="d1-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
    </fieldset>

    <!-- Safe -->
    <fieldset class="col" aria-labelledby="safe-legend">
      <legend id="safe-legend">Safe</legend>
      <div class="row">
        <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
      </div>
      <div class="row"><label for="safe-q">Quarters</label><input id="safe-q" name="safe-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="safe-q-r" name="safe-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
      <div class="row"><label for="safe-d">Dimes</label><input id="safe-d" name="safe-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="safe-d-r" name="safe-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
      <div class="row"><label for="safe-n">Nickels</label><input id="safe-n" name="safe-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="safe-n-r" name="safe-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
      <div class="row"><label for="safe-p">Pennies</label><input id="safe-p" name="safe-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="safe-p-r" name="safe-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
      <div class="row"><label for="safe-clip1">Clips of $1 (=$20)</label><input id="safe-clip1" name="safe-clip1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-1">Loose $1</label><input id="safe-1" name="safe-1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-5">Loose $5</label><input id="safe-5" name="safe-5" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-10">Loose $10</label><input id="safe-10" name="safe-10" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-20">Loose $20</label><input id="safe-20" name="safe-20" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-50">Loose $50</label><input id="safe-50" name="safe-50" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
      <div class="row"><label for="safe-100">Loose $100</label><input id="safe-100" name="safe-100" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
    </fieldset>
  </div>

  <section class="totals" aria-live="polite">
    <div class="totals-grid totals-grid--main">
      <div class="box"><span class="label">Drawer 3</span><span class="value" id="t3">$0.00</span></div>
      <div class="box"><span class="label">Drawer 2</span><span class="value" id="t2">$0.00</span></div>
      <div class="box"><span class="label">Drawer 1</span><span class="value" id="t1">$0.00</span></div>
      <div class="box"><span class="label">Safe subtotal</span><span class="value" id="ts">$0.00</span></div>
    </div>
    <div class="totals-grid totals-grid--wide">
      <div class="box"><span class="label">All drawers + safe</span><span class="value" id="tall">$0.00</span></div>
    </div>
  </section>

  <script>
    (async function(){
      const $ = (sel, el=document) => el.querySelector(sel);

      // Denomination cents and roll values in cents to avoid float errors
      const keys = ['q','d','n','p'];
      const valuesC = [25,10,5,1];
      const rollC   = [1000,500,200,50]; // quarters,dimes,nickels,pennies
      const safeCoinKeys = keys;
      const safeBillKeys = ['clip1','1','5','10','20','50','100'];
      const safeBillValuesC = { clip1: 2000, '1': 100, '5': 500, '10': 1000, '20': 2000, '50': 5000, '100': 10000 };
      const drawers = [3,2,1];

      const dateKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      $('#date-key').textContent = dateKey;

      // Map of input ids per drawer: [[['d3-q','d3-q-r'], ...], ...]
      const idsByDrawer = drawers.map(d => keys.map(k => [`d${d}-${k}`, `d${d}-${k}-r`]));
      const safeCoinIds = safeCoinKeys.map(k => [`safe-${k}`, `safe-${k}-r`]);
      const safeBillIds = safeBillKeys.map(k => [`safe-${k}`, null]);

      const fmt = cents => (cents/100).toLocaleString('en-US', {style:'currency',currency:'USD'});

      function readInt(el){
        const v = parseInt(el.value, 10);
        return isNaN(v) || v < 0 ? 0 : v;
      }

      function readDrawerCounts(drawerNum){
        const counts = {};
        keys.forEach((k)=>{
          counts[k] = readInt(document.getElementById(`d${drawerNum}-${k}`));
          counts[`${k}R`] = readInt(document.getElementById(`d${drawerNum}-${k}-r`));
        });
        return counts;
      }

      function readSafeCounts(){
        const coins = {};
        safeCoinKeys.forEach((k)=>{
          coins[k] = readInt(document.getElementById(`safe-${k}`));
          coins[`${k}R`] = readInt(document.getElementById(`safe-${k}-r`));
        });
        const bills = {};
        safeBillKeys.forEach((k)=>{
          bills[k] = readInt(document.getElementById(`safe-${k}`));
        });
        return { coins, bills };
      }

      function applyDrawerCounts(drawerNum, counts){
        if (!counts) return;
        keys.forEach((k)=>{
          const loose = counts[k];
          const rolls = counts[`${k}R`];
          if (typeof loose === 'number') {
            document.getElementById(`d${drawerNum}-${k}`).value = loose;
          }
          if (typeof rolls === 'number') {
            document.getElementById(`d${drawerNum}-${k}-r`).value = rolls;
          }
        });
      }

      function applySafeCounts(counts){
        if (!counts) return;
        safeCoinKeys.forEach((k)=>{
          const loose = counts.coins?.[k];
          const rolls = counts.coins?.[`${k}R`];
          if (typeof loose === 'number') {
            document.getElementById(`safe-${k}`).value = loose;
          }
          if (typeof rolls === 'number') {
            document.getElementById(`safe-${k}-r`).value = rolls;
          }
        });
        safeBillKeys.forEach((k)=>{
          const val = counts.bills?.[k];
          if (typeof val === 'number') {
            document.getElementById(`safe-${k}`).value = val;
          }
        });
      }

      function calc(){
        // returns totals in cents for each drawer [d3,d2,d1]
        const totalsC = [0,0,0];
        idsByDrawer.forEach((pairs, di)=>{
          pairs.forEach(([looseId, rollId], i)=>{
            const loose = readInt(document.getElementById(looseId));
            const rolls = readInt(document.getElementById(rollId));
            totalsC[di] += loose * valuesC[i] + rolls * rollC[i];
          });
        });

        let safeTotalC = 0;
        safeCoinIds.forEach(([looseId, rollId], i)=>{
          const loose = readInt(document.getElementById(looseId));
          const rolls = readInt(document.getElementById(rollId));
          safeTotalC += loose * valuesC[i] + rolls * rollC[i];
        });
        safeBillKeys.forEach((k)=>{
          const count = readInt(document.getElementById(`safe-${k}`));
          safeTotalC += count * safeBillValuesC[k];
        });

        const grandTotalC = totalsC.reduce((a,b)=>a+b,0) + safeTotalC;

        // render
        $('#t3').textContent = fmt(totalsC[0]);
        $('#t2').textContent = fmt(totalsC[1]);
        $('#t1').textContent = fmt(totalsC[2]);
        $('#ts').textContent = fmt(safeTotalC);
        $('#tall').textContent = fmt(grandTotalC);
        return { totalsC, safeTotalC, grandTotalC };
      }

      function selectOnFocus(e){ e.target.select(); }
      function keepSelection(e){ e.preventDefault(); }

      let saveTimer;
      async function saveCounts(){
        const drawersPayload = {};
        drawers.forEach((d)=>{ drawersPayload[d] = readDrawerCounts(d); });
        const safePayload = readSafeCounts();
        try {
          await fetch(`/api/count?date=${encodeURIComponent(dateKey)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drawers: drawersPayload, safe: safePayload })
          });
        } catch (err) {
          console.error('Save failed', err);
          toast('Unable to save right now.');
        }
      }

      function queueSave(){
        clearTimeout(saveTimer);
        saveTimer = setTimeout(saveCounts, 400);
      }

      // Wire inputs
      const allInputIds = [
        ...idsByDrawer.flat().flat(),
        ...safeCoinIds.flat(),
        ...safeBillIds.flat().filter(Boolean)
      ];

      allInputIds.forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => { calc(); queueSave(); });
        el.addEventListener('focus', selectOnFocus);
        el.addEventListener('mouseup', keepSelection);
      });

      // Balance (round down to whole dollars by removing loose coins only)
      document.querySelectorAll('[data-balance]').forEach(btn => {
        btn.addEventListener('click', () => {
          const drawerNum = parseInt(btn.getAttribute('data-balance'), 10); // 3/2/1
          const di = drawers.indexOf(drawerNum); // 0/1/2
          const totalsC = calc();
          let cents = totalsC[di] % 100; // amount to remove
          if (cents === 0) { toast('Already whole dollars.'); return; }

          // Current loose counts for this drawer
          const looseIds = keys.map((k)=>`d${drawerNum}-${k}`);
          const looseCounts = looseIds.map(id => readInt(document.getElementById(id)));

          const toRemove = [0,0,0,0];
          for (let i=0;i<valuesC.length;i++){
            const need = Math.floor(cents / valuesC[i]);
            if (need <= 0) continue;
            const take = Math.min(need, looseCounts[i]);
            toRemove[i] = take;
            cents -= take * valuesC[i];
          }

          if (cents > 0) { toast('Not enough loose change to balance.'); return; }

          // Apply removals
          for (let i=0;i<toRemove.length;i++){
            if (toRemove[i] > 0){
              const el = document.getElementById(looseIds[i]);
              el.value = Math.max(0, readInt(el) - toRemove[i]);
            }
          }
          calc();
          queueSave();
          toast('Balanced to whole dollars.');
        });
      });

      function toast(msg){
        const t = document.createElement('div');
        t.className='toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 1200);
      }

      // --- Lightweight tests (console) ---
      (function tests(){
        function computeTotalCents(loose, rolls){
          // loose/rolls arrays in order [q,d,n,p]
          let c=0; for(let i=0;i<4;i++){ c += loose[i]*valuesC[i] + rolls[i]*rollC[i]; } return c;
        }
        console.group('ChangeCount tests');
        console.assert(computeTotalCents([1,0,0,0],[0,0,0,0]) === 25, 'Quarter loose = 25¢');
        console.assert(computeTotalCents([0,0,0,0],[1,0,0,0]) === 1000, 'Quarter roll = $10');
        console.assert(safeBillValuesC.clip1 === 2000, 'Clip of $1s worth $20');
        // Balance logic sample: $8.41 should remove [1,1,1,1] if all exist
        (function(){
          let cents=41, avail=[5,5,5,5], take=[0,0,0,0];
          for(let i=0;i<4;i++){ const need=Math.floor(cents/valuesC[i]); const got=Math.min(need, avail[i]); take[i]=got; cents-=got*valuesC[i]; }
          console.assert(JSON.stringify(take)==='[1,1,1,1]' && cents===0, 'Greedy removal 41¢');
        })();
        console.groupEnd();
      })();

      async function loadSavedCounts(){
        try {
          const res = await fetch(`/api/count?date=${encodeURIComponent(dateKey)}`);
          if (res.ok) {
            const payload = await res.json();
            if (payload && payload.drawers) {
              drawers.forEach((d)=> applyDrawerCounts(d, payload.drawers[d]));
              applySafeCounts(payload.safe);
            }
          } else {
            console.warn('Load failed', res.status);
          }
        } catch (err) {
          console.error('Load failed', err);
          toast('Unable to load saved counts.');
        }
      }

      // initial render
      await loadSavedCounts();
      calc();
    })();
  </script>
</body>
</html>
