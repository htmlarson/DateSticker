<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Change Count</title>
  <style>
    :root { --bg:#0b1221; --panel:#0f172a; --ink:#e5e7eb; --line:#243249; --muted:#9ca3af; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:radial-gradient(circle at 20% 20%,rgba(255,255,255,.04),rgba(255,255,255,0)),var(--bg);color:var(--ink);padding:24px}
    .page{max-width:1200px;margin:0 auto}
    h1{margin:0 0 10px;text-align:center;letter-spacing:.01em}
    .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:0 0 10px;flex-wrap:wrap}
    .store{display:flex;align-items:center;gap:12px;color:#9ca3af;font-weight:700;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .store__label{text-transform:uppercase;letter-spacing:.05em;font-size:.85rem;color:#9ca3af;margin-bottom:4px}
    .store__value{font-size:1.1rem;color:var(--ink);font-weight:800;letter-spacing:.08em}
    .store__error{color:#f87171;font-weight:700;font-size:.9rem;margin-top:8px;min-height:1.1em}
    .store__actions{display:flex;align-items:center;gap:8px;margin-left:auto}
    .store__pill{padding:6px 10px;border-radius:999px;background:#1e293b;color:#cbd5e1;font-weight:700;font-size:.85rem;letter-spacing:.05em;border:1px solid var(--line)}
    .store-overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.68);backdrop-filter:blur(4px);z-index:200;transition:opacity .25s ease,visibility .25s ease}
    .store-overlay[hidden]{opacity:0;visibility:hidden}
    .store-overlay__card{width:min(480px,90vw);padding:24px;border-radius:18px;background:linear-gradient(180deg,#111a2c,#0b1221);border:1px solid var(--line);box-shadow:0 18px 50px rgba(0,0,0,.45);display:grid;gap:14px}
    .store-overlay__title{font-weight:900;font-size:1.1rem;letter-spacing:.02em;color:#e5e7eb}
    .store-overlay__lead{color:#cbd5e1;font-weight:600}
    .store-input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink);text-align:center;font-weight:800;letter-spacing:.08em;font-size:1.05rem}
    .store-input:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .store-overlay__actions{display:flex;gap:10px;justify-content:flex-end;align-items:center}
    .date-row{display:flex;justify-content:center;align-items:center;gap:10px;color:#9ca3af;margin:6px 0 18px;font-weight:600}
    .date-row label{text-transform:uppercase;letter-spacing:.05em;font-size:.85rem}
    .date-row input[type=date]{background:rgba(255,255,255,.04);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:700;letter-spacing:.02em}
    .date-row input[type=date]:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .last-edited{color:var(--muted);text-align:center;font-weight:700;margin:-8px 0 14px;letter-spacing:.01em}
    .wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;align-items:start;margin-top:10px}
    .colwrap{display:grid;gap:12px;height:100%;align-self:start;padding:16px;border:1px solid var(--line);border-radius:18px;background:var(--panel);box-shadow:0 18px 40px rgba(0,0,0,.32)}
    .colwrap--safe{grid-column:1/-1;max-width:720px;justify-self:center;width:100%;padding:0;background:none;border:0;box-shadow:none}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}

    fieldset{border:1px solid var(--line);border-radius:14px;min-width:0;width:100%;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
    legend{padding:7px 12px;border:1px solid var(--line);border-radius:999px;font-weight:700;letter-spacing:.01em;background:var(--panel);box-shadow:0 4px 12px rgba(0,0,0,.28)}

    .col{padding:14px}
    .drawer legend{color:#f3f4f6}
    /* label | loose | rolls */
    .row{display:grid;grid-template-columns:1fr 110px 110px;align-items:center;gap:12px;padding:8px 0;border-bottom:1px dashed var(--line)}
    .row:last-child{border-bottom:0}
    .row--safe-heading,.row--safe{grid-template-columns:1fr 120px}
    .row--bill-heading{grid-template-columns:1fr 110px 110px;font-weight:700;color:#e5e7eb}
    .row--bill{grid-template-columns:1fr 110px 110px}
    label{color:#d1d5db;font-weight:600}
    input[type=number]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--ink);text-align:right;transition:border-color .15s ease,box-shadow .15s ease}
    input[type=number]:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    input[type=number].flash-success{animation:flash-success .6s ease}
    input[type=number].flash-error{animation:flash-error .6s ease}
    .hintcell{color:var(--muted);font-size:.82rem;text-align:center;font-weight:600;letter-spacing:.01em}

    @keyframes flash-success{0%{box-shadow:0 0 0 0 rgba(52,211,153,.8);border-color:#34d399}100%{box-shadow:0 0 0 10px rgba(52,211,153,0);border-color:var(--line)}}
    @keyframes flash-error{0%{box-shadow:0 0 0 0 rgba(248,113,113,.8);border-color:#f87171}100%{box-shadow:0 0 0 10px rgba(248,113,113,0);border-color:var(--line)}}

    .totals-stack{display:grid;gap:10px}
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center;background:var(--panel);box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .label{display:block;color:var(--muted);font-size:0.85rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em}
    .value{font-variant-numeric:tabular-nums;font-weight:800;font-size:1.05rem}

    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:-4px -4px 10px 0}
    button{background:linear-gradient(180deg,#111a2c,#0d1423);border:1px solid var(--line);color:var(--ink);padding:7px 12px;border-radius:10px;font-weight:700;cursor:pointer;letter-spacing:.01em;transition:transform .08s ease,filter .15s ease}
    button:hover{filter:brightness(1.1)}
    button:active{transform:translateY(1px)}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0f172a;border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:#e5e7eb;z-index:100}
  </style>
</head>
  <body>
  <div class="page">
    <h1>Change Count</h1>
    <div class="top-row">
      <div class="store">
        <div>
          <div class="store__label">Store #</div>
          <div class="store__value" id="store-display">—</div>
          <div class="store__pill" id="store-status">Not set</div>
        </div>
        <div class="store__actions">
          <button type="button" id="store-change" aria-label="Change store number">Change</button>
        </div>
      </div>
      <div class="date-row">
        <label for="date-picker">For</label>
        <input type="date" id="date-picker" />
      </div>
    </div>
    <div class="store-overlay" id="store-overlay" role="dialog" aria-modal="true">
      <div class="store-overlay__card">
        <div class="store-overlay__title">Enter your store number to start</div>
        <div class="store-overlay__lead">All counts are saved per store per day. Please enter your six-digit store number.</div>
        <input id="store-input" name="store-input" class="store-input" type="text" inputmode="numeric" pattern="\d{6}" maxlength="6" placeholder="000000" aria-label="Store number" autocomplete="off" />
        <div class="store__error" id="store-error" aria-live="assertive"></div>
        <div class="store-overlay__actions">
          <button type="button" id="store-save">Save store</button>
        </div>
      </div>
    </div>
    <div class="last-edited" id="last-edited">Last edited: —</div>
    <div class="wrap">
      <!-- Drawer 1 -->
      <div class="colwrap">
        <fieldset class="col drawer" aria-labelledby="d1-legend">
          <legend id="d1-legend">Drawer 1</legend>
          <div class="controls"><button type="button" data-balance="1">Balance</button></div>
          <div class="row">
            <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
          </div>
          <div class="row"><label for="d1-q">Quarters</label><input id="d1-q" name="d1-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-q-r" name="d1-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d1-d">Dimes</label><input id="d1-d" name="d1-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-d-r" name="d1-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d1-n">Nickels</label><input id="d1-n" name="d1-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-n-r" name="d1-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d1-p">Pennies</label><input id="d1-p" name="d1-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d1-p-r" name="d1-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row row--bill-heading"><span></span><div class="hintcell">Bills</div><div class="hintcell">—</div></div>
          <div class="row row--bill"><label for="d1-1">$1</label><input id="d1-1" name="d1-1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d1-5">$5</label><input id="d1-5" name="d1-5" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d1-10">$10</label><input id="d1-10" name="d1-10" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d1-20">$20</label><input id="d1-20" name="d1-20" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d1-50">$50</label><input id="d1-50" name="d1-50" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d1-100">$100</label><input id="d1-100" name="d1-100" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
        </fieldset>
        <div class="box"><span class="label">Drawer 1 subtotal</span><span class="value" id="t1">$0.00</span></div>
      </div>

      <!-- Drawer 2 -->
      <div class="colwrap">
        <fieldset class="col drawer" aria-labelledby="d2-legend">
          <legend id="d2-legend">Drawer 2</legend>
          <div class="controls"><button type="button" data-balance="2">Balance</button></div>
          <div class="row">
            <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
          </div>
          <div class="row"><label for="d2-q">Quarters</label><input id="d2-q" name="d2-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-q-r" name="d2-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d2-d">Dimes</label><input id="d2-d" name="d2-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-d-r" name="d2-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d2-n">Nickels</label><input id="d2-n" name="d2-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-n-r" name="d2-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d2-p">Pennies</label><input id="d2-p" name="d2-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d2-p-r" name="d2-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row row--bill-heading"><span></span><div class="hintcell">Bills</div><div class="hintcell">—</div></div>
          <div class="row row--bill"><label for="d2-1">$1</label><input id="d2-1" name="d2-1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d2-5">$5</label><input id="d2-5" name="d2-5" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d2-10">$10</label><input id="d2-10" name="d2-10" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d2-20">$20</label><input id="d2-20" name="d2-20" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d2-50">$50</label><input id="d2-50" name="d2-50" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d2-100">$100</label><input id="d2-100" name="d2-100" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
        </fieldset>
        <div class="box"><span class="label">Drawer 2 subtotal</span><span class="value" id="t2">$0.00</span></div>
      </div>

      <!-- Drawer 3 -->
      <div class="colwrap">
        <fieldset class="col drawer" aria-labelledby="d3-legend">
          <legend id="d3-legend">Drawer 3</legend>
          <div class="controls"><button type="button" data-balance="3">Balance</button></div>
          <div class="row">
            <span></span><div class="hintcell">Loose</div><div class="hintcell">Rolls</div>
          </div>
          <div class="row"><label for="d3-q">Quarters</label><input id="d3-q" name="d3-q" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-q-r" name="d3-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d3-d">Dimes</label><input id="d3-d" name="d3-d" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-d-r" name="d3-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d3-n">Nickels</label><input id="d3-n" name="d3-n" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-n-r" name="d3-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row"><label for="d3-p">Pennies</label><input id="d3-p" name="d3-p" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><input id="d3-p-r" name="d3-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0" tabindex="-1"></div>
          <div class="row row--bill-heading"><span></span><div class="hintcell">Bills</div><div class="hintcell">—</div></div>
          <div class="row row--bill"><label for="d3-1">$1</label><input id="d3-1" name="d3-1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d3-5">$5</label><input id="d3-5" name="d3-5" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d3-10">$10</label><input id="d3-10" name="d3-10" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d3-20">$20</label><input id="d3-20" name="d3-20" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d3-50">$50</label><input id="d3-50" name="d3-50" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row row--bill"><label for="d3-100">$100</label><input id="d3-100" name="d3-100" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
        </fieldset>
        <div class="box"><span class="label">Drawer 3 subtotal</span><span class="value" id="t3">$0.00</span></div>
      </div>

      <!-- Safe -->
      <div class="colwrap colwrap--safe">
        <fieldset class="col" aria-labelledby="safe-legend">
          <legend id="safe-legend">Safe</legend>
          <div class="row row--safe-heading">
            <span></span><div class="hintcell">Rolls</div>
          </div>
          <div class="row row--safe"><label for="safe-q-r">Quarters</label><input id="safe-q-r" name="safe-q-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
          <div class="row row--safe"><label for="safe-d-r">Dimes</label><input id="safe-d-r" name="safe-d-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
          <div class="row row--safe"><label for="safe-n-r">Nickels</label><input id="safe-n-r" name="safe-n-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
          <div class="row row--safe"><label for="safe-p-r">Pennies</label><input id="safe-p-r" name="safe-p-r" type="number" min="0" step="1" inputmode="numeric" placeholder="0"></div>
          <div class="row"><label for="safe-clip1">Clips of $1 (=$20)</label><input id="safe-clip1" name="safe-clip1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-1">Loose $1</label><input id="safe-1" name="safe-1" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-5">Loose $5</label><input id="safe-5" name="safe-5" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-10">Loose $10</label><input id="safe-10" name="safe-10" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-20">Loose $20</label><input id="safe-20" name="safe-20" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-50">Loose $50</label><input id="safe-50" name="safe-50" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
          <div class="row"><label for="safe-100">Loose $100</label><input id="safe-100" name="safe-100" type="number" min="0" step="1" inputmode="numeric" placeholder="0"><span class="hintcell">—</span></div>
        </fieldset>
        <div class="totals-stack">
          <div class="box"><span class="label">Safe subtotal</span><span class="value" id="ts">$0.00</span></div>
          <div class="box"><span class="label">All drawers + safe</span><span class="value" id="tall">$0.00</span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (async function(){
      const $ = (sel, el=document) => el.querySelector(sel);

      // Denomination cents and roll values in cents to avoid float errors
      const coinKeys = ['q','d','n','p'];
      const coinValuesC = [25,10,5,1];
      const rollC   = [1000,500,200,50]; // quarters,dimes,nickels,pennies
      const billKeys = ['1','5','10','20','50','100'];
      const billValuesC = { '1': 100, '5': 500, '10': 1000, '20': 2000, '50': 5000, '100': 10000 };
      const safeCoinKeys = coinKeys;
      const safeBillKeys = ['clip1','1','5','10','20','50','100'];
      const safeBillValuesC = { clip1: 2000, '1': 100, '5': 500, '10': 1000, '20': 2000, '50': 5000, '100': 10000 };
      const drawers = [1,2,3];

      const datePicker = document.getElementById('date-picker');
      const lastEditedEl = document.getElementById('last-edited');
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      datePicker.value = today;
      let dateKey = datePicker.value || today;

      function renderLastEdited(iso){
        if (!iso) { lastEditedEl.textContent = 'Last edited: —'; return; }
        const parsed = new Date(iso);
        if (isNaN(parsed.getTime())) { lastEditedEl.textContent = 'Last edited: —'; return; }
        const formatted = parsed.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
        lastEditedEl.textContent = `Last edited: ${formatted}`;
      }

      // Map of input ids per drawer: [[['d3-q','d3-q-r'], ...], ...]
      const idsByDrawer = drawers.map(d => {
        const coinIds = coinKeys.map(k => [`d${d}-${k}`, `d${d}-${k}-r`]);
        const billIds = billKeys.map(k => [`d${d}-${k}`, null]);
        return [...coinIds, ...billIds];
      });
      const safeCoinRollIds = safeCoinKeys.map(k => `safe-${k}-r`);
      const safeBillIds = safeBillKeys.map(k => [`safe-${k}`, null]);

      const fmt = cents => (cents/100).toLocaleString('en-US', {style:'currency',currency:'USD'});
      const STORE_STORAGE_KEY = 'change-count-store-number';
      let storeNumber = null;
      let storeEditing = false;
      let lastInputEl = null;

      const storeDisplay = document.getElementById('store-display');
      const storeInput = document.getElementById('store-input');
      const storeSaveBtn = document.getElementById('store-save');
      const storeChangeBtn = document.getElementById('store-change');
      const storeStatus = document.getElementById('store-status');
      const storeOverlay = document.getElementById('store-overlay');
      const storeError = document.getElementById('store-error');

      function updateDateKey(newDate){
        dateKey = newDate || today;
        datePicker.value = dateKey;
      }

      function normalizeStoreNumber(value){
        const cleaned = (value || '').replace(/\D+/g, '').slice(0, 6);
        return /^\d{6}$/.test(cleaned) ? cleaned : null;
      }

      function renderStore(){
        storeDisplay.textContent = storeNumber || '—';
        storeStatus.textContent = storeNumber ? `Using store ${storeNumber}` : 'Store required';
        storeError.textContent = '';

        if (!storeNumber) {
          storeEditing = true;
        }

        if (storeEditing) {
          storeOverlay.hidden = false;
          storeInput.disabled = false;
          storeInput.value = storeNumber || '';
          storeInput.focus();
          storeSaveBtn.disabled = false;
        } else {
          storeOverlay.hidden = true;
          storeInput.disabled = true;
          storeInput.value = '';
          storeSaveBtn.disabled = true;
        }

        storeChangeBtn.disabled = storeEditing;
      }

      function persistStoreNumber(value){
        storeNumber = value;
        localStorage.setItem(STORE_STORAGE_KEY, storeNumber);
        storeEditing = false;
        renderStore();
      }

      function ensureStoreNumber(){
        const normalized = normalizeStoreNumber(localStorage.getItem(STORE_STORAGE_KEY));
        if (normalized) {
          storeNumber = normalized;
          storeEditing = false;
        } else {
          localStorage.removeItem(STORE_STORAGE_KEY);
          storeNumber = null;
          storeEditing = true;
        }
        renderStore();
      }

      storeSaveBtn.addEventListener('click', async () => {
        const normalized = normalizeStoreNumber(storeInput.value);
        if (!normalized) {
          storeError.textContent = 'Enter a 6-digit store number.';
          storeInput.focus();
          return;
        }
        if (normalized !== storeNumber) {
          persistStoreNumber(normalized);
          clearAllInputs();
          renderLastEdited(null);
          await loadSavedCounts();
          calc();
        } else {
          storeEditing = false;
          renderStore();
        }
      });

      storeChangeBtn.addEventListener('click', () => {
        storeEditing = true;
        renderStore();
        storeInput.focus();
        storeInput.select();
      });

      storeInput.addEventListener('input', () => {
        storeError.textContent = '';
        const normalized = storeInput.value.replace(/\D+/g, '').slice(0, 6);
        storeInput.value = normalized;
      });

      function readInt(el){
        const v = parseInt(el.value, 10);
        return isNaN(v) || v < 0 ? 0 : v;
      }

      function markLastInput(el){
        lastInputEl = el;
      }

      function flashInput(status){
        if (!lastInputEl) return;
        const cls = status === 'success' ? 'flash-success' : 'flash-error';
        lastInputEl.classList.remove('flash-success', 'flash-error');
        // Force reflow so the animation can retrigger
        void lastInputEl.offsetWidth;
        lastInputEl.classList.add(cls);
        setTimeout(() => lastInputEl.classList.remove(cls), 650);
      }

      function readDrawerCounts(drawerNum){
        const counts = { coins: {}, bills: {} };
        coinKeys.forEach((k)=>{
          counts.coins[k] = readInt(document.getElementById(`d${drawerNum}-${k}`));
          counts.coins[`${k}R`] = readInt(document.getElementById(`d${drawerNum}-${k}-r`));
        });
        billKeys.forEach((k)=>{
          counts.bills[k] = readInt(document.getElementById(`d${drawerNum}-${k}`));
        });
        return counts;
      }

      function readSafeCounts(){
        const coins = {};
        safeCoinKeys.forEach((k, i)=>{
          coins[k] = 0;
          coins[`${k}R`] = readInt(document.getElementById(safeCoinRollIds[i]));
        });
        const bills = {};
        safeBillKeys.forEach((k)=>{
          bills[k] = readInt(document.getElementById(`safe-${k}`));
        });
        return { coins, bills };
      }

      function applyDrawerCounts(drawerNum, counts){
        if (!counts) return;
        coinKeys.forEach((k)=>{
          const loose = counts.coins?.[k] ?? counts[k];
          const rolls = counts.coins?.[`${k}R`] ?? counts[`${k}R`];
          if (typeof loose === 'number') {
            document.getElementById(`d${drawerNum}-${k}`).value = loose;
          }
          if (typeof rolls === 'number') {
            document.getElementById(`d${drawerNum}-${k}-r`).value = rolls;
          }
        });
        billKeys.forEach((k)=>{
          const val = counts.bills?.[k] ?? counts[k];
          if (typeof val === 'number') {
            document.getElementById(`d${drawerNum}-${k}`).value = val;
          }
        });
      }

      function applySafeCounts(counts){
        if (!counts) return;
        safeCoinKeys.forEach((k, i)=>{
          const rolls = counts.coins?.[`${k}R`];
          if (typeof rolls === 'number') {
            document.getElementById(safeCoinRollIds[i]).value = rolls;
          }
        });
        safeBillKeys.forEach((k)=>{
          const val = counts.bills?.[k];
          if (typeof val === 'number') {
            document.getElementById(`safe-${k}`).value = val;
          }
        });
      }

      function calc(){
        const drawerTotalsC = { 1:0, 2:0, 3:0 };
        drawers.forEach((drawerNum)=>{
          let subtotal = 0;
          coinKeys.forEach((k, i)=>{
            const loose = readInt(document.getElementById(`d${drawerNum}-${k}`));
            const rolls = readInt(document.getElementById(`d${drawerNum}-${k}-r`));
            subtotal += loose * coinValuesC[i] + rolls * rollC[i];
          });
          billKeys.forEach((k)=>{
            const count = readInt(document.getElementById(`d${drawerNum}-${k}`));
            subtotal += count * billValuesC[k];
          });
          drawerTotalsC[drawerNum] = subtotal;
        });

        let safeTotalC = 0;
        safeCoinRollIds.forEach((rollId, i)=>{
          const rolls = readInt(document.getElementById(rollId));
          safeTotalC += rolls * rollC[i];
        });
        safeBillKeys.forEach((k)=>{
          const count = readInt(document.getElementById(`safe-${k}`));
          safeTotalC += count * safeBillValuesC[k];
        });

        const drawersTotalC = drawers.reduce((acc, d)=> acc + drawerTotalsC[d], 0);
        const grandTotalC = drawersTotalC + safeTotalC;

        // render
        $('#t1').textContent = fmt(drawerTotalsC[1]);
        $('#t2').textContent = fmt(drawerTotalsC[2]);
        $('#t3').textContent = fmt(drawerTotalsC[3]);
        $('#ts').textContent = fmt(safeTotalC);
        $('#tall').textContent = fmt(grandTotalC);
        return { drawerTotalsC, safeTotalC, grandTotalC };
      }

      function selectOnFocus(e){ e.target.select(); }
      function keepSelection(e){ e.preventDefault(); }

      let saveTimer;
      async function saveCounts(){
        if (!storeNumber) { storeError.textContent = 'Store number required to save.'; return; }
        const drawersPayload = {};
        drawers.forEach((d)=>{ drawersPayload[d] = readDrawerCounts(d); });
        const safePayload = readSafeCounts();
        try {
          const res = await fetch(`/api/count?date=${encodeURIComponent(dateKey)}&store=${encodeURIComponent(storeNumber)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drawers: drawersPayload, safe: safePayload })
          });
          if (res.ok) {
            const payload = await res.json().catch(()=> null);
            renderLastEdited(payload?.updatedAt);
            flashInput('success');
          } else {
            flashInput('error');
            toast('Unable to save right now.');
          }
        } catch (err) {
          console.error('Save failed', err);
          toast('Unable to save right now.');
          flashInput('error');
        }
      }

      function queueSave(){
        clearTimeout(saveTimer);
        saveTimer = setTimeout(saveCounts, 400);
      }

      // Wire inputs
      const allInputIds = [
        ...idsByDrawer.flat().flat().filter(Boolean),
        ...safeCoinRollIds,
        ...safeBillIds.flat().filter(Boolean)
      ];

      function clearAllInputs(){
        allInputIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      }

      allInputIds.forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => { markLastInput(el); calc(); queueSave(); });
        el.addEventListener('focus', selectOnFocus);
        el.addEventListener('mouseup', keepSelection);
      });

      datePicker.addEventListener('change', async () => {
        clearTimeout(saveTimer);
        updateDateKey(datePicker.value);
        clearAllInputs();
        renderLastEdited(null);
        await loadSavedCounts();
        calc();
      });

      // Balance (round down to whole dollars by removing loose coins only)
      document.querySelectorAll('[data-balance]').forEach(btn => {
        btn.addEventListener('click', () => {
          const drawerNum = parseInt(btn.getAttribute('data-balance'), 10);
          const { drawerTotalsC } = calc();
          let cents = drawerTotalsC[drawerNum] % 100; // amount to remove
          if (cents === 0) { toast('Already whole dollars.'); return; }

          // Current loose counts for this drawer
          const looseIds = coinKeys.map((k)=>`d${drawerNum}-${k}`);
          const looseCounts = looseIds.map(id => readInt(document.getElementById(id)));

          const toRemove = [0,0,0,0];
          for (let i=0;i<coinValuesC.length;i++){
            const need = Math.floor(cents / coinValuesC[i]);
            if (need <= 0) continue;
            const take = Math.min(need, looseCounts[i]);
            toRemove[i] = take;
            cents -= take * coinValuesC[i];
          }

          if (cents > 0) { toast('Not enough loose change to balance.'); return; }

          // Apply removals
          for (let i=0;i<toRemove.length;i++){
            if (toRemove[i] > 0){
              const el = document.getElementById(looseIds[i]);
              el.value = Math.max(0, readInt(el) - toRemove[i]);
              markLastInput(el);
            }
          }
          calc();
          queueSave();
          toast('Balanced to whole dollars.');
        });
      });

      function toast(msg){
        const t = document.createElement('div');
        t.className='toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 1200);
      }

      // --- Lightweight tests (console) ---
      (function tests(){
        function computeTotalCents(loose, rolls){
          // loose/rolls arrays in order [q,d,n,p]
          let c=0; for(let i=0;i<4;i++){ c += loose[i]*coinValuesC[i] + rolls[i]*rollC[i]; } return c;
        }
        console.group('ChangeCount tests');
        console.assert(computeTotalCents([1,0,0,0],[0,0,0,0]) === 25, 'Quarter loose = 25¢');
        console.assert(computeTotalCents([0,0,0,0],[1,0,0,0]) === 1000, 'Quarter roll = $10');
        console.assert(safeBillValuesC.clip1 === 2000, 'Clip of $1s worth $20');
        // Balance logic sample: $8.41 should remove [1,1,1,1] if all exist
        (function(){
          let cents=41, avail=[5,5,5,5], take=[0,0,0,0];
          for(let i=0;i<4;i++){ const need=Math.floor(cents/coinValuesC[i]); const got=Math.min(need, avail[i]); take[i]=got; cents-=got*coinValuesC[i]; }
          console.assert(JSON.stringify(take)==='[1,1,1,1]' && cents===0, 'Greedy removal 41¢');
        })();
        console.groupEnd();
      })();

      async function loadSavedCounts(){
        if (!storeNumber) { return; }
        try {
          const res = await fetch(`/api/count?date=${encodeURIComponent(dateKey)}&store=${encodeURIComponent(storeNumber)}`);
          if (res.ok) {
            const payload = await res.json();
            if (payload && payload.drawers) {
              drawers.forEach((d)=> applyDrawerCounts(d, payload.drawers[d]));
              applySafeCounts(payload.safe);
            }
            renderLastEdited(payload?.updatedAt);
          } else {
            console.warn('Load failed', res.status);
            renderLastEdited(null);
          }
        } catch (err) {
          console.error('Load failed', err);
          toast('Unable to load saved counts.');
          renderLastEdited(null);
        }
      }

      // initial render
      ensureStoreNumber();
      renderLastEdited(null);
      if (storeNumber) {
        await loadSavedCounts();
      }
      calc();
    })();
  </script>
</body>
</html>
